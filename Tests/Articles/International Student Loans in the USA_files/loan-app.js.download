// Generated by CoffeeScript 2.4.1
(function() {
  $(document).ready(function() {
    var LoanApp, STEP_DEGREE_SOUGHT, STEP_GRAD_DATE, STEP_SCHOOL_INFO, STEP_US_CITIZEN, STEP_US_COSIGNER, loanApp;
    STEP_US_CITIZEN = {
      step: 'us-citizen',
      progress: '0',
      forward: function() {
        var usCitizenVal;
        $('#value-' + this.step).text($('#loanapplication-us_citizen option:selected').text());
        if (loanApp.requiresEmail) {
          $('#value-' + this.step + '-email').text($('#loanapplication-email').val());
        }
        if (loanApp.requiresLoanSemester) {
          $('#value-' + this.step + '-loan_semester').text($('#loanapplication-loan_semester option:selected').text());
        }
        usCitizenVal = $('#loanapplication-us_citizen').val();
        if (usCitizenVal === '1') {
          if (loanApp.requiresLoanSemester) {
            if ($('#loanapplication-loan_semester').val() < 1) {
              $('#loan-app-form').yiiActiveForm('validateAttribute', 'loanapplication-us_citizen');
              $('#loan-app-form').yiiActiveForm('validateAttribute', 'loanapplication-loan_semester');
              return true;
            }
          }
          loanApp.nextStep = STEP_SCHOOL_INFO;
          return loanApp.transitionStep(true);
        } else if (usCitizenVal === '0') {
          if (loanApp.requiresLoanSemester) {
            if ($('#loanapplication-loan_semester').val() < 1) {
              $('#loan-app-form').yiiActiveForm('validateAttribute', 'loanapplication-us_citizen');
              $('#loan-app-form').yiiActiveForm('validateAttribute', 'loanapplication-loan_semester');
              return true;
            }
          }
          loanApp.nextStep = STEP_US_COSIGNER;
          return loanApp.transitionStep(true);
        } else {
          $('#loan-app-form').yiiActiveForm('validateAttribute', 'loanapplication-us_citizen');
          if (loanApp.requiresEmail) {
            $('#loan-app-form').yiiActiveForm('validateAttribute', 'loanapplication-email');
          }
          if (loanApp.requiresLoanSemester) {
            return $('#loan-app-form').yiiActiveForm('validateAttribute', 'loanapplication-loan_semester');
          }
        }
      },
      backward: function() {
        loanApp.nextStep = STEP_US_CITIZEN;
        loanApp.slideUpCrumbs(['us-citizen', 'us-cosigner', 'degree-sought', 'grad-date']);
        return loanApp.transitionStep(false);
      },
      beforeTransition: function() {
        $('#loanapplication-us_citizen').prop('selectedIndex', 0);
        return true;
      }
    };
    STEP_US_COSIGNER = {
      step: 'us-cosigner',
      progress: '25',
      forward: function() {
        var usCosignerVal;
        $('#value-' + this.step).text($('#loanapplication-with_cosigner option:selected').text());
        usCosignerVal = $('#loanapplication-with_cosigner').val();
        if (usCosignerVal === '1') {
          loanApp.nextStep = STEP_SCHOOL_INFO;
          return loanApp.transitionStep(true);
        } else if (usCosignerVal === '0') {
          loanApp.nextStep = STEP_DEGREE_SOUGHT;
          return loanApp.transitionStep(true);
        } else {
          return $('#loan-app-form').yiiActiveForm('validateAttribute', 'loanapplication-with_cosigner');
        }
      },
      backward: function() {
        loanApp.nextStep = STEP_US_COSIGNER;
        loanApp.slideUpCrumbs(['us-cosigner', 'degree-sought', 'grad-date']);
        return loanApp.transitionStep(false);
      },
      beforeTransition: function() {
        $('#loanapplication-with_cosigner').prop('selectedIndex', 0);
        return true;
      }
    };
    STEP_DEGREE_SOUGHT = {
      step: 'degree-sought',
      progress: '50',
      forward: function() {
        var degreeSoughtVal;
        $('#value-' + this.step).text($('#loanapplication-education_level option:selected').text());
        degreeSoughtVal = $('#loanapplication-education_level').val();
        if (degreeSoughtVal === '2') { //bachelors
          loanApp.nextStep = STEP_GRAD_DATE;
          return loanApp.transitionStep(true);
        } else if (degreeSoughtVal === '3') { //masters
          loanApp.nextStep = STEP_SCHOOL_INFO;
          return loanApp.transitionStep(true);
        } else {
          return $('#loan-app-form').yiiActiveForm('validateAttribute', 'loanapplication-education_level');
        }
      },
      backward: function() {
        loanApp.nextStep = STEP_DEGREE_SOUGHT;
        loanApp.slideUpCrumbs(['degree-sought', 'grad-date']);
        return loanApp.transitionStep(false);
      },
      beforeTransition: function() {
        $('#loanapplication-education_level').prop('selectedIndex', 0);
        return true;
      }
    };
    STEP_GRAD_DATE = {
      step: 'grad-date',
      progress: '75',
      forward: function() {
        var gradDateVal, regEx, validDate;
        gradDateVal = $('#loanapplication-graduation_date').val();
        regEx = /^\d{4}-\d{2}-\d{2}$/g;
        validDate = regEx.test(gradDateVal);
        if (gradDateVal !== '' && validDate === true) {
          $('#value-' + this.step).text(gradDateVal);
          loanApp.nextStep = STEP_SCHOOL_INFO;
          return loanApp.transitionStep(true);
        } else {
          return $('#loan-app-form').yiiActiveForm('validateAttribute', 'loanapplication-graduation_date');
        }
      },
      backward: function() {
        loanApp.nextStep = STEP_GRAD_DATE;
        loanApp.slideUpCrumbs(['grad-date']);
        return loanApp.transitionStep(false);
      },
      beforeTransition: function() {
        $('#loanapplication-graduation_date').val('');
        return true;
      }
    };
    STEP_SCHOOL_INFO = {
      step: 'school-info',
      progress: '100',
      forward: function() {
        if ($('#loanapplication-school_country').is('select')) {
          if ($('#loanapplication-school_country').val() < 1) {
            $('#loan-app-form').yiiActiveForm('validateAttribute', 'loanapplication-school_country');
            return false;
          }
        }
        if ($('#loanapplication-school_state').is('select')) {
          if ($('#loanapplication-school_state').val() < 1) {
            $('#loan-app-form').yiiActiveForm('validateAttribute', 'loanapplication-school_state');
            return false;
          }
        }
        if ($('#loanapplication-school_id').is('select')) {
          if ($('#loanapplication-school_id').val() < 1) {
            $('#loan-app-form').yiiActiveForm('validateAttribute', 'loanapplication-school_id');
            return false;
          }
        }
        return $('#loan-app-form').submit();
      },
      backward: function() {},
      //Since there is no step after this one, we can't go backwards to it.
      beforeTransition: function() {
        if ($('#loanapplication-school_id').is('input')) {
          //If this field is an input then we can assume its hidden and filled out, so we should go ahead and submit.
          $('#loan-app-form').submit();
          return false;
        } else if ($('#loanapplication-school_country').is('select')) {
          loanApp.addLoader();
          $('#loanapplication-school_country').html('');
          $.ajax({
            url: loanApp.countriesActionUrl,
            type: 'GET',
            dataType: 'json',
            data: $('#loan-app-form').serialize(),
            success: function(data) {
              return $('#loanapplication-school_country').html(data);
            },
            complete: function() {
              return loanApp.removeLoader();
            },
            error: function(e) {
              return console.log(e);
            }
          });
        }
        return true;
      }
    };
    LoanApp = (function() {
      class LoanApp {
        constructor() {
          this.nextStep = '';
          this.currentStep = STEP_US_CITIZEN;
          this.finalStep = STEP_SCHOOL_INFO.step;
          //The widget sets these globally, but to be safe we should fallback to the most likely path for each url we use.
          if (typeof window.schoolsAction === 'undefined') {
            window.schoolsAction = '/apply/schools/';
          }
          this.schoolsActionUrl = window.schoolsAction;
          if (typeof window.regionsAction === 'undefined') {
            window.regionsAction = '/apply/regions/';
          }
          this.regionsActionUrl = window.regionsAction;
          if (typeof window.countriesAction === 'undefined') {
            window.countriesAction = '/apply/countries/';
          }
          this.countriesActionUrl = window.countriesAction;
          if (typeof window.appRequiresEmail === 'undefined') {
            window.appRequiresEmail = false;
          }
          this.requiresEmail = window.appRequiresEmail;
          if (typeof window.appRequiresLoanSemester === 'undefined') {
            window.appRequiresLoanSemester = false;
          }
          this.requiresLoanSemester = window.appRequiresLoanSemester;
        }

        transitionStep(isForward) {
          var shouldContinue;
          //Any functionality custom to the step we are about to move to that should happen before we process the transition
          shouldContinue = this.nextStep.beforeTransition();
          if (shouldContinue) {
            if (this.nextStep.step === this.finalStep) {
              $('#loan-app-next-btn').text('Find My Loan');
            } else {
              $('#loan-app-next-btn').text('Next');
            }
            if (isForward) {
              $('#loan-crumb-' + this.currentStep.step).slideDown();
            }
            $('#step-' + this.currentStep.step).hide();
            $('#step-' + this.nextStep.step).show();
            $('.progress-bar').attr('style', 'width:' + this.nextStep.progress + '%;');
            //Reset Steps
            this.currentStep = this.nextStep;
            return this.nextStep = '';
          }
        }

        slideUpCrumbs(steps) {
          var i, j, ref, results;
          results = [];
          for (i = j = 0, ref = steps.length; (0 <= ref ? j < ref : j > ref); i = 0 <= ref ? ++j : --j) {
            results.push($('#loan-crumb-' + steps[i]).slideUp());
          }
          return results;
        }

        addLoader() {
          $('#loan-step-container').prepend('<i id="loan-loader-icon" class="fa fa-circle-o-notch fa-spin fa-4x fa-fw" style="position:absolute;top: 50%;left: 50%;margin-left: -35px;"></i>');
          return $('#loan-step-container').css('opacity', '0.4');
        }

        removeLoader() {
          $('#loan-step-container #loan-loader-icon').remove();
          return $('#loan-step-container').css('opacity', '1.0');
        }

        clearSchool() {
          var schoolIsSelect, stateIsSelect;
          schoolIsSelect = $('#loanapplication-school_id').is('select');
          stateIsSelect = $('#loanapplication-school_state').is('select');
          if (schoolIsSelect && stateIsSelect) {
            $('#loanapplication-school_id').attr('disabled', true);
            return $('#loanapplication-school_id').html('');
          } else if (schoolIsSelect) {
            return $('#loanapplication-school_id').prop('selectedIndex', 0);
          }
        }

        clearState() {
          if ($('#loanapplication-school_state').is('select')) {
            $('.field-loanapplication-school_state').hide();
            return $('#loanapplication-school_state').html('');
          }
        }

        run() {
          var _this;
          _this = this;
          $('#loan-app-next-btn').on('click', function() {
            return _this.currentStep.forward();
          });
          //Backwards Progress Event Handlers
          $('#us-citizen-edit').on('click', function() {
            _this.clearSchool();
            _this.clearState();
            return STEP_US_CITIZEN.backward();
          });
          $('#us-cosigner-edit').on('click', function() {
            _this.clearSchool();
            _this.clearState();
            return STEP_US_COSIGNER.backward();
          });
          $('#degree-sought-edit').on('click', function() {
            _this.clearSchool();
            _this.clearState();
            return STEP_DEGREE_SOUGHT.backward();
          });
          $('#grad-date-edit').on('click', function() {
            _this.clearSchool();
            _this.clearState();
            return STEP_GRAD_DATE.backward();
          });
          if ($('#loanapplication-school_country').is('select')) {
            $('#loanapplication-school_country').on('change', function() {
              var countryId;
              _this.addLoader();
              _this.clearSchool();
              _this.clearState();
              countryId = $(this).val();
              if (countryId !== '') {
                return $.ajax({
                  url: _this.regionsActionUrl,
                  type: 'GET',
                  dataType: 'json',
                  data: {
                    countryId: countryId
                  },
                  success: function(data) {
                    $('#loanapplication-school_state').html(data);
                    if (countryId === '254') {
                      $('.field-loanapplication-school_state').show();
                    }
                    //Since state data is changing we should manually trigger the change event
                    return $('#loanapplication-school_state').trigger('change');
                  },
                  complete: function() {
                    return _this.removeLoader();
                  },
                  error: function(e) {
                    return console.log(e);
                  }
                });
              } else {
                return _this.removeLoader();
              }
            });
          }
          if ($('#loanapplication-school_state').is('select')) {
            return $('#loanapplication-school_state').on('change', function() {
              _this.addLoader();
              _this.clearSchool();
              if ($(this).val() !== '') {
                return $.ajax({
                  url: _this.schoolsActionUrl,
                  type: 'GET',
                  dataType: 'json',
                  data: $('#loan-app-form').serialize(),
                  success: function(data) {
                    $('#loanapplication-school_id').html(data);
                    return $('#loanapplication-school_id').attr('disabled', false);
                  },
                  complete: function() {
                    return _this.removeLoader();
                  },
                  error: function(e) {
                    return console.log(e);
                  }
                });
              } else {
                return _this.removeLoader();
              }
            });
          }
        }

      };

      $('.datepicker').attr('autocomplete', 'off');

      return LoanApp;

    }).call(this);
    loanApp = new LoanApp();
    return loanApp.run();
  });

}).call(this);

//# sourceMappingURL=loan-app.js.map
